---
title: "Untitled"
output: output_format
---

```{r setup, include=FALSE}
library(targets)
knitr::opts_chunk$set(echo = TRUE, tar_interactive = FALSE)
targets::tar_unscript()
```

```{targets set-globals, tar_globals=TRUE, include=FALSE}
future::plan(future::multisession, workers = 8)
games <- tarflow.iquizoo::search_games_mem(config::get("where"))
tar_option_set(
  package = c("tidyverse", "dataproc.iquizoo"), 
  format = "qs", 
  imports = "dataproc.iquizoo"
)
targets_data <- tarchetypes::tar_map(
  values = games,
  names = game_name_abbr,
  tar_target(
    scores,
    tarflow.iquizoo::fetch_single_game(
      query_tmpl_scores, game_id, config_where
    )
  ),
  tar_target(
    data,
    tarflow.iquizoo::fetch_single_game(
      query_tmpl_data, game_id, config_where
    )
  ),
  tar_target(data_parsed, wrangle_data(data, name_key = key)),
  tar_target(indices, preproc_data(data_parsed, prep_fun, by = key))
)
```

```{targets load-config, include=FALSE}
list(
  tar_target(file_config, "config.yml", format = "file"),
  tar_target(config_where, config::get("where", file = file_config))
)
```

```{targets download-users, include=FALSE}
list(
  tar_target(query_tmpl_users, fs::path("sql", "users.tmpl.sql"), format = "file"),
  tar_target(users, tarflow.iquizoo::fetch(query_tmpl_users, config_where))
)
```

```{targets data-and-scores, include=FALSE}
list(
  tar_target(query_scores_tmpl, fs::path("sql", "scores.tmpl.sql"), format = "file"),
  tar_target(query_tmpl_data, fs::path("sql", "data.tmpl.sql"), format = "file"),
  tar_target(key, ".id"),
  targets_data
)
```

```{r run-pipeline, include=FALSE}
tar_make_future()
```
